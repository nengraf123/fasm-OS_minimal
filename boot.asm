; boot.asm  -- BIOS boot sector (512 bytes)                     ; Описывает назначение файла — загрузочный сектор BIOS, размером 512 байт
org 0x7C00                                                    ; Устанавливает начало кода по адресу 0x7C00 (стандарт для загрузочного сектора)
use16                                                         ; Указывает, что используется 16-битный режим процессора

start:                                                        ; Метка начала программы
    cli                                                       ; Отключает прерывания для предотвращения внешних вмешательств
    xor ax, ax                                                ; Обнуляет регистр AX (AX = 0) для инициализации сегментов
    mov ds, ax                                                ; Устанавливает сегмент данных (DS) в 0
    mov es, ax                                                ; Устанавливает дополнительный сегмент (ES) в 0
    mov ss, ax                                                ; Устанавливает сегмент стека (SS) в 0
    mov sp, 0x7C00                                            ; Устанавливает указатель стека (SP) на 0x7C00 (начало загрузочного сектора)

    ; ОЧИСТКА ЭКРАНА                                          ; Комментарий для блока очистки экрана
    mov ax, 0x0003                                            ; Устанавливает видеорежим 0x03 (текстовый режим 80x25) в AX
    int 0x10                                                  ; Вызывает прерывание BIOS для установки видеорежима (очищает экран)

    ; Спрятать курсор                                         ; Комментарий для блока скрытия курсора
    mov ah, 0x01                                              ; Устанавливает функцию 0x01 (управление курсором) в AH
    mov ch, 0x20                                              ; Устанавливает бит для отключения отображения курсора
    mov cl, 0x00                                              ; Устанавливает нулевое значение для CL (не используется в данном случае)
    int 0x10                                                  ; Вызывает прерывание BIOS для применения настроек курсора

    ; Сохранить загрузочное устройство (DL)                   ; Комментарий для сохранения информации о загрузочном устройстве
    mov [boot_drive], dl                                      ; Сохраняет номер загрузочного устройства (из DL) в переменную boot_drive

    ; Загрузить kernel в 0x0000:0x8000                       ; Комментарий для блока загрузки ядра
    mov ax, 0x0000                                            ; Устанавливает сегмент ES в 0x0000 для адресации памяти
    mov es, ax                                                ; Применяет значение AX (0x0000) к сегменту ES
    mov bx, 0x8000                                            ; Устанавливает смещение BX в 0x8000 (адрес для загрузки ядра)

    ; Параметры для чтения диска                             ; Комментарий для параметров чтения с диска
    mov ah, 0x02                                              ; Устанавливает функцию 0x02 (чтение секторов) в AH
    mov al, 4                                                 ; Устанавливает количество секторов для чтения (4 сектора)
    mov ch, 0                                                 ; Устанавливает номер цилиндра (0)
    mov cl, 2                                                 ; Устанавливает номер сектора (2, так как 1-й сектор — это сам загрузчик)
    mov dh, 0                                                 ; Устанавливает номер головки (0)
    mov dl, [boot_drive]                                      ; Устанавливает номер загрузочного устройства из переменной boot_drive
    int 0x13                                                  ; Вызывает прерывание BIOS для чтения секторов с диска
    jc disk_error                                             ; Переходит к метке disk_error, если произошла ошибка (флаг carry установлен)

    ; Переход к ядру                                         ; Комментарий для перехода к ядру
    jmp 0x0000:0x8000                                         ; Выполняет дальний переход к адресу ядра (0x0000:0x8000)

disk_error:                                                   ; Метка для обработки ошибки чтения диска
    ; При ошибке тоже очищаем экран                         ; Комментарий для очистки экрана при ошибке
    mov ax, 0x0003                                            ; Устанавливает видеорежим 0x03 (текстовый режим 80x25) для очистки экрана
    int 0x10                                                  ; Вызывает прерывание BIOS для очистки экрана

    mov si, disk_err_msg                                      ; Устанавливает SI на адрес строки с сообщением об ошибке
    mov ah, 0x0E                                              ; Устанавливает функцию 0x0E (вывод символа на экран) в AH
    mov bh, 0                                                 ; Устанавливает номер страницы видео (0) в BH
.print_loop:                                                  ; Метка для цикла вывода сообщения
    lodsb                                                     ; Загружает очередной байт из строки (по адресу SI) в AL и увеличивает SI
    test al, al                                               ; Проверяет, является ли текущий символ нулевым (конец строки)
    jz .hang                                                  ; Если символ нулевой, переходит к метке .hang
    int 0x10                                                  ; Вызывает прерывание BIOS для вывода символа на экран
    jmp .print_loop                                           ; Переходит к началу цикла для вывода следующего символа

.hang:                                                        ; Метка для бесконечного ожидания
    hlt                                                       ; Останавливает процессор (энергосберегающий режим)
    jmp .hang                                                 ; Бесконечный переход к метке .hang для предотвращения дальнейшего выполнения

; Данные                                                  ; Комментарий для секции данных
boot_drive db 0                                               ; Определяет переменную boot_drive (1 байт) для хранения номера загрузочного устройства
disk_err_msg db "Disk error!", 0                              ; Определяет строку с сообщением об ошибке, завершающуюся нулевым байтом

times 510 - ($ - $$) db 0                                     ; Заполняет оставшееся пространство до 510 байт нулями
dw 0xAA55                                                     ; Устанавливает сигнатуру загрузочного сектора (0xAA55) в конце
